<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

        <style>
            * {
                font-family: 'Roboto', sans-serif;
            }

            body {
                background-color: #999999;
                max-width: 960px;
                margin: 0 auto 0 auto;
                display: flexbox;
                flex-direction: column;
                justify-content: center;
                align-items: stretch;
            }

            body div {
                display: flex;
                justify-content: center;
            }

            .searchDiv {
                display: flexbox;
                margin: 0 0 0 20px;
                flex-direction: row;
                justify-content: center;
                align-items: stretch;
            }

            .searchDiv div {
                display: flexbox;
                margin: 0 20px 0 0;
                flex-direction: column;
                justify-content: left;
                align-items: stretch;
            }

            .searchDiv div div {
                display: flexbox;
                flex-direction: row;
            }

            .reqDiv input {
                margin: auto;
                height: 14px;
            }

            .tableDiv {
                margin: 20px 0 0 0;
                display: flex;
            }

            .tableDiv table {
                flex-grow: 1;
                border: 1px solid #7a7a7a;
                margin-bottom: 4px;
            }

            .tableDiv table thead {
                background-color: #8c8c8c;
            }

            .tableDiv table tbody tr {
                border: solid;
                border-width: 1px 0;
            }
        </style>
    </head>
    <body>
        <div class="headerDiv">
            <h1>WynnCraft ingredient search tool</h1>
        </div>
        <div class="searchBar">
            <input type="text" style="flex-grow: 8;" id="nameInput">
            <button style="flex-grow: 2;" onclick="SearchIng()">Search</button>
        </div>
        <div class="searchDiv">
            <div>
                <p style="align-self: center;">Rarity</p>
                <div>
                    <input type="checkbox" name="rarity0Chk" id="rarity0Chk">
                    <label for="rarity0Chk"> ✫✫✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity1Chk" id="rarity1Chk">
                    <label for="rarity1Chk"> <span style="color: yellow;">✫</span>✫✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity2Chk" id="rarity2Chk">
                    <label for="rarity2Chk"> <span style="color: yellow;">✫✫</span>✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity3Chk" id="rarity3Chk">
                    <label for="rarity3Chk"> <span style="color: yellow;">✫✫✫</span></label>
                </div>
            </div>
            <div>
                <p style="align-self: center;">Professions</p>
                <div>
                    <input type="checkbox" name="profArmo" id="profArmo">
                    <label for="profArmo">Armouring</label>
                </div>
                <div>
                    <input type="checkbox" name="profTail" id="profTail">
                    <label for="profTail">Tailoring</label>
                </div>
                <div>
                    <input type="checkbox" name="profWeap" id="profWeap">
                    <label for="profWeap">Weaponsmithing</label>
                </div>
                <div>
                    <input type="checkbox" name="profWood" id="profWood">
                    <label for="profWood">Woodworking</label>
                </div>
                <div>
                    <input type="checkbox" name="profJewe" id="profJewe">
                    <label for="profJewe">Jeweling</label>
                </div>
                <div>
                    <input type="checkbox" name="profAlch" id="profAlch">
                    <label for="profAlch">Alchemism</label>
                </div>
                <div>
                    <input type="checkbox" name="profScri" id="profScri">
                    <label for="profScri">Scribing</label>
                </div>
                <div>
                    <input type="checkbox" name="profCook" id="profCook">
                    <label for="profCook">Cooking</label>
                </div>
            </div>
            <div>
                <p style="align-self: center;">Requirements</p>
                <div class="reqDiv">
                    <p>Level:&nbsp</p>
                    <input type="number" name="reqMinLvl" id="reqMinLvl" value="1" style="max-width: 60px;">
                    <p>&nbsp-&nbsp</p>
                    <input type="number" name="reqMaxLvl" id="reqMaxLvl" value="150" style="max-width: 60px;">
                </div>

            </div>
        </div>
        <div class="tableDiv">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Identifications</th>
                        <th>Usage</th>
                    </tr>
                </thead>
            </table>
        </div>

        <script>
            let ingList = [];
            let ingDict = {};
            
            function Get(yourUrl){
                let Httpreq = new XMLHttpRequest();
                Httpreq.open("GET",yourUrl,false);
                Httpreq.send(null);
                return Httpreq.responseText;          
            }

            function VerifyIngDict() {
                if (Object.keys(ingList).length === 0) {
                    console.debug("Fetching ingredient list");
                    let dataJson = JSON.parse(Get("https://shadowtrolll.github.io/WynnBase/Resources/ingredient_list.json"));
                    if (dataJson["code"] !== 200) return false; 
                    ingList = dataJson["data"];
                }

                if (Object.keys(ingDict).length === 0) {
                    console.debug("Fetching ingredient data");
                    ingDict = JSON.parse(Get("https://shadowtrolll.github.io/WynnBase/ProcessedData.json"));
                }

                return true;
            }

            function SearchIng() {
                if (!VerifyIngDict()) return;

                // -------------- Read filter data into memory -----------------
                let nameFilter = document.getElementById("nameInput").value;
                let rarityFilter = [
                    document.getElementById("rarity0Chk").checked, 
                    document.getElementById("rarity1Chk").checked,
                    document.getElementById("rarity2Chk").checked,
                    document.getElementById("rarity3Chk").checked
                ]; 
                let profFilter = {
                    "WEAPONSMITHING": document.getElementById("profWeap").checked,
                    "WOODWORKING": document.getElementById("profWood").checked,
                    "ARMOURING": document.getElementById("profArmo").checked,
                    "TAILORING": document.getElementById("profTail").checked,
                    "JEWELING": document.getElementById("profJewe").checked,
                    "COOKING": document.getElementById("profCook").checked,
                    "ALCHEMISM": document.getElementById("profAlch").checked,
                    "SCRIBING": document.getElementById("profScri").checked
                };
                let lvlMin = document.getElementById("reqMinLvl").value;
                let lvlMax = document.getElementById("reqMaxLvl").value;

                let doFilterRarity = rarityFilter.some(item => item != false);
                let doFilterProf = Object.keys(profFilter).map(function(key){
                    return profFilter[key];
                    }).some(item => item != false);


                // -------------- Filter ingredients -----------------
                let results = [...ingList];
                results = results.filter(function(value, index, arr) { 
                    return typeof(ingDict[value]) !== "undefined";
                });

                if (nameFilter !== "") {
                    console.debug("Filtering by name");
                    results = results.filter(function(value, index, arr) { 
                        return value.includes(nameFilter);
                    });
                }
                
                if (doFilterProf) {
                    console.debug("Filtering by profession");
                    results = results.filter(function(value, index, arr) { 
                        return ingDict[value]["skills"].some(item => profFilter[item]);
                    });
                }

                if (doFilterRarity) {
                    console.debug("Filtering by rarity");
                    results = results.filter(function(value, index, arr) { 
                        return rarityFilter[ingDict[value]["tier"]];
                    });
                }



                // -------------- Output into table -----------------
                let dataTable = document.getElementById("dataTable");
                dataTable.innerHTML = "";

                for (ingName of results) {
                    let ingObj = ingDict[ingName];

                    let row = dataTable.insertRow();
                    CreateIngRow(row, ingObj);
                }

                let tHead = dataTable.createTHead();
                let row = tHead.insertRow();
                for (headName of ["Ingredient", "Identifications", "Usage"]) {
                    let cell = row.insertCell();
                    let colText = document.createElement("th");
                    colText.innerHTML = headName
                    cell.appendChild(colText); 
                }
            }

            function CreateIngRow(row, ingObj) {
                let cell = row.insertCell();
                let colPar = document.createElement("p");
                colPar.innerHTML = (ingName + " [" + "<span style=\"color: yellow;\">" + "✫".repeat(ingObj["tier"]) + "</span>" + "✫".repeat(3 - ingObj["tier"]) + "]");
                colPar.style = "margin: 2px 0 2px 0;";
                cell.appendChild(colPar);

                cell = row.insertCell();
                colPar = document.createElement("div");
                let parText = "";
                let propDict = ingObj["identifications"];
                for (propName in propDict) {
                    parText += propName + " from " + propDict[propName]["minimum"] + " to " + propDict[propName]["maximum"] + "\n";
                }
                colPar.innerHTML = (parText);
                colPar.style = "margin: 2px 0 2px 0; white-space: pre-wrap;";
                cell.appendChild(colPar);

                cell = row.insertCell();
                colPar = document.createElement("p");
                colPar.innerHTML = (ingObj["skills"].join(", ").toLowerCase());
                colPar.style = "margin: 2px 0 2px 0; max-width: 180px;";
                cell.appendChild(colPar);
            }
        </script>
    </body>
</html>