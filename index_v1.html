<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

        <style>
            * {
                font-family: 'Roboto', sans-serif;
                color: #949494;
            }

            body {
                background-color: #363636;
                max-width: 1080px;
                width: 80%;
                margin: 0 auto 0 auto;
                display: flexbox;
                flex-direction: column;
                justify-content: center;
                align-items: stretch;
            }

            body div {
                display: flex;
                justify-content: center;
            }

            .searchDiv {
                display: flexbox;
                margin: 0 0 0 20px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                align-items: stretch;
            }

            .searchDiv div {
                display: flexbox;
                margin: 0 20px 0 0;
                flex-direction: column;
                justify-content: left;
                align-items: stretch;
            }

            .searchDiv div div {
                display: flexbox;
                flex-direction: row;
            }

            .reqDiv input {
                margin: auto;
                height: 14px;
            }

            .dataContainer {
                display: flexbox;
                margin: 10px 0 0 0;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }

            .dataContainer div {
                display: flexbox;
                margin: 4px;
                flex-direction: column;
                justify-content: center;
                background-color: #17121f;
                border: 4px solid #643494 ;
                border-radius: 2px;
            }

            .dataContainer div div {
                display: flex;
                margin: 2px 6px 2px 6px;
                align-items: center;   
                border: none;
                border-bottom: 1px solid #643494;
            }

            .dataContainer div p {
                margin: 0 0 0 0;
            }
        </style>
    </head>
    <body onload="VerifyIngDict()">
        <div class="headerDiv">
            <h1>WynnCraft ingredient search tool</h1>
        </div>
        <div class="searchBar">
            <input type="text" style="flex-grow: 8;" id="nameInput">
            <button style="flex-grow: 2;" onclick="SearchIng()">Search</button>
        </div>
        <div class="searchDiv">
            <div>
                <p style="align-self: center;">Rarity</p>
                <div>
                    <input type="checkbox" name="rarity0Chk" id="rarity0Chk">
                    <label for="rarity0Chk"> ✫✫✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity1Chk" id="rarity1Chk">
                    <label for="rarity1Chk"> <span style="color: yellow;">✫</span>✫✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity2Chk" id="rarity2Chk">
                    <label for="rarity2Chk"> <span style="color: yellow;">✫✫</span>✫</label>
                </div>
                <div>
                    <input type="checkbox" name="rarity3Chk" id="rarity3Chk">
                    <label for="rarity3Chk"> <span style="color: yellow;">✫✫✫</span></label>
                </div>
            </div>
            <div>
                <p style="align-self: center;">Professions</p>
                <div>
                    <input type="checkbox" name="profArmo" id="profArmo">
                    <label for="profArmo">Armouring</label>
                </div>
                <div>
                    <input type="checkbox" name="profTail" id="profTail">
                    <label for="profTail">Tailoring</label>
                </div>
                <div>
                    <input type="checkbox" name="profWeap" id="profWeap">
                    <label for="profWeap">Weaponsmithing</label>
                </div>
                <div>
                    <input type="checkbox" name="profWood" id="profWood">
                    <label for="profWood">Woodworking</label>
                </div>
                <div>
                    <input type="checkbox" name="profJewe" id="profJewe">
                    <label for="profJewe">Jeweling</label>
                </div>
                <div>
                    <input type="checkbox" name="profAlch" id="profAlch">
                    <label for="profAlch">Alchemism</label>
                </div>
                <div>
                    <input type="checkbox" name="profScri" id="profScri">
                    <label for="profScri">Scribing</label>
                </div>
                <div>
                    <input type="checkbox" name="profCook" id="profCook">
                    <label for="profCook">Cooking</label>
                </div>
            </div>
            <div>
                <p style="align-self: center;">Requirements</p>
                <div class="reqDiv">
                    <p>Level:&nbsp</p>
                    <input type="number" name="reqMinLvl" id="reqMinLvl" value="1" style="max-width: 60px;">
                    <p>&nbsp-&nbsp</p>
                    <input type="number" name="reqMaxLvl" id="reqMaxLvl" value="150" style="max-width: 60px;">
                </div>

            </div>
        </div>
        <div class="dataContainer" id="dataContainer">
        </div>

        <script>
            let ingList = [];
            let ingDict = {};
            
            function Get(yourUrl){
                let Httpreq = new XMLHttpRequest();
                Httpreq.open("GET",yourUrl,false);
                Httpreq.send(null);
                return Httpreq.responseText;          
            }

            function VerifyIngDict() {
                if (Object.keys(ingList).length === 0) {
                    console.debug("Fetching ingredient list");
                    let dataJson = JSON.parse(Get("https://shadowtrolll.github.io/WynnBase/Resources/ingredient_list.json"));
                    if (dataJson["code"] !== 200) return false; 
                    ingList = dataJson["data"];
                }

                if (Object.keys(ingDict).length === 0) {
                    console.debug("Fetching ingredient data");
                    ingDict = JSON.parse(Get("https://shadowtrolll.github.io/WynnBase/ProcessedData.json"));
                }

                ingList = ingList.filter(function(value, index, arr) { 
                    return typeof(ingDict[value]) !== "undefined";
                });

                ingList = ingList.sort(function(a, b){return ingDict[b]["level"] - ingDict[a]["level"]});

                let dataCont = document.getElementById("dataContainer");
                for (ingName of ingList) {
                    let ingObj = ingDict[ingName];
                    dataCont.appendChild(CreateIngBox(ingObj));
                }

                let inputElements = document.getElementsByTagName("input");
                for (inputEl of inputElements) {
                    if (inputEl.id === "nameInput") continue;
                    console.debug("Adding listener to " + inputEl.id);
                    inputEl.onchange = SearchIng;
                }

                return true;
            }

            function SearchIng() {
                // -------------- Read filter data into memory -----------------
                let nameFilter = document.getElementById("nameInput").value;
                let rarityFilter = [
                    document.getElementById("rarity0Chk").checked, 
                    document.getElementById("rarity1Chk").checked,
                    document.getElementById("rarity2Chk").checked,
                    document.getElementById("rarity3Chk").checked
                ]; 
                let profFilter = {
                    "WEAPONSMITHING": document.getElementById("profWeap").checked,
                    "WOODWORKING": document.getElementById("profWood").checked,
                    "ARMOURING": document.getElementById("profArmo").checked,
                    "TAILORING": document.getElementById("profTail").checked,
                    "JEWELING": document.getElementById("profJewe").checked,
                    "COOKING": document.getElementById("profCook").checked,
                    "ALCHEMISM": document.getElementById("profAlch").checked,
                    "SCRIBING": document.getElementById("profScri").checked
                };
                let lvlMin = document.getElementById("reqMinLvl").value;
                let lvlMax = document.getElementById("reqMaxLvl").value;

                let doFilterRarity = rarityFilter.some(item => item != false);
                let doFilterProf = Object.keys(profFilter).map(function(key){
                    return profFilter[key];
                    }).some(item => item != false);


                // -------------- Filter ingredients -----------------
                let results = [...ingList];

                if (nameFilter !== "") {
                    console.debug("Filtering by name");
                    results = results.filter(function(value, index, arr) { 
                        return value.includes(nameFilter);
                    });
                }
                
                if (doFilterProf) {
                    console.debug("Filtering by profession");
                    results = results.filter(function(value, index, arr) { 
                        return ingDict[value]["skills"].some(item => profFilter[item]);
                    });
                }

                if (doFilterRarity) {
                    console.debug("Filtering by rarity");
                    results = results.filter(function(value, index, arr) { 
                        return rarityFilter[ingDict[value]["tier"]];
                    });
                }

                console.debug("Filtering by level");
                results = results.filter(function(value, index, arr) { 
                    return (lvlMin <= ingDict[value]["level"]) && (ingDict[value]["level"] <= lvlMax);
                });


                // -------------- Show results in container -----------------
                let dataCont = document.getElementById("dataContainer");

                for (ingName of ingList) {
                    let ingBox = document.getElementById("ingBox_" + ingName.replace(/\s/g, '_'));
                    ingBox.style = "display: none;";
                }

                for (ingName of results) {
                    let ingBox = document.getElementById("ingBox_" + ingName.replace(/\s/g, '_'));
                    ingBox.style = "";
                }
            }

            function CreateIngBox(ingObj) {
                let ingBox = document.createElement("div");

                let sectionDiv = document.createElement("div");
                let textPar = document.createElement("p");
                textPar.innerHTML = ingName + " [" + "<span style=\"color: yellow;\">" + "✫".repeat(ingObj["tier"]) + "</span>" + "✫".repeat(3 - ingObj["tier"]) + "]";
                sectionDiv.appendChild(textPar);
                ingBox.appendChild(sectionDiv);
            
                sectionDiv = document.createElement("div");
                let propDict = ingObj["identifications"];
                for (propName in propDict) {
                    textPar = document.createElement("p");
                    textPar.innerHTML = propName + " from " + propDict[propName]["minimum"] + " to " + propDict[propName]["maximum"];
                    sectionDiv.appendChild(textPar);
                }
                textPar = document.createElement("p");
                textPar.innerHTML = "<br>";
                sectionDiv.appendChild(textPar);
                propDict = ingObj["ingredientPositionModifiers"];
                for (propName in propDict) {
                    if (propDict[propName] === 0) continue;
                    textPar = document.createElement("p");
                    textPar.innerHTML = propName + ": " + propDict[propName];
                    sectionDiv.appendChild(textPar);
                }
                ingBox.appendChild(sectionDiv);

                sectionDiv = document.createElement("div");
                propDict = ingObj["itemOnlyIDs"];
                for (propName in propDict) {
                    if (propDict[propName] === 0) continue;
                    textPar = document.createElement("p");
                    textPar.innerHTML = propName + ": " + propDict[propName];
                    sectionDiv.appendChild(textPar);
                }
                textPar = document.createElement("p");
                textPar.innerHTML = "<br>";
                sectionDiv.appendChild(textPar);
                propDict = ingObj["consumableOnlyIDs"];
                for (propName in propDict) {
                    if (propDict[propName] === 0) continue;
                    textPar = document.createElement("p");
                    textPar.innerHTML = propName + ": " + propDict[propName];
                    sectionDiv.appendChild(textPar);
                }
                ingBox.appendChild(sectionDiv);

                sectionDiv = document.createElement("div");
                textPar = document.createElement("p");
                textPar.innerHTML = "Requires level:&nbsp" + ingObj["level"];
                sectionDiv.appendChild(textPar);
                propDict = ingObj["skills"];
                for (propName in propDict) {
                    textPar = document.createElement("p");
                    textPar.innerHTML = propDict[propName];
                    sectionDiv.appendChild(textPar);
                }
                ingBox.appendChild(sectionDiv);

                ingBox.id = "ingBox_" + ingName.replace(/\s/g, '_');
                return ingBox;
            }
        </script>
    </body>
</html>